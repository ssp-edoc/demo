<!DOCTYPE html>
<html>
    <head>
            <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
            integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
            crossorigin=""/>
    </head>
    <style>
        div[data-map] { height: 180px; }
    </style>
<body>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            options = {
                divId: 'content',
                customerId: 'chrisx',
                apiUrl: 'http://localhost/api/',
                
                idPortenProfileUrl: 'https://brukerprofil.difi.no/minprofil',
                siteroot: 'https://skjema.no',
                idleTimeoutMinutes: 100,
                idleTimeoutWarningMinutes: 2,
                
                hideHeader: 'false',
                hideFooter: 'false',
                hideSaveButton: 'false',
                hideAbortButton: 'false',
                skipPrompt: false
            };            

            setLoaderVisibility(true);

            viewer
                .init(initOptions)
                .session(sessionOptions)
                .form({
                    divId: "viewer",
                    formDefinition: 
                    {
                        "caption": "Nytt eDocument",
                        "id": "a8c7a512-e8b3-4051-8167-37782ed48146",
                        "fromCore": true,
                        "pages": [
                            {
                            "caption": "Side 1",
                            "id": "9326c495-92f4-4f1e-b4dd-90e6e4e2eb84",
                            "name": "Side_1",
                            "fields": [
                                {
                                    "caption": "Foo",
                                    "id": "foo",
                                    "uiType": "text",
                                },
                                {
                                    "caption": "Bar",
                                    "id": "bar",
                                    "uiType": "text",
                                },
                                {
                                    "uiType": "map", //kobling til extension nedenfor
                                    "longtitude": 51.505, //egendefinerte egenskaper
                                    "latitude": -0.09, //egendefinerte egenskaper
                                    "id": "map1", //brukes som key til lagring i coreModel
                                },
                                {
                                    "uiType": "map", 
                                    "longtitude": 151.505,
                                    "latitude": -110.09,
                                    "id": "map2", 
                                },                                
                                {
                                    "uiType": "chart", 
                                    "customChartProperty1": "som chart property value", //egendefinerte egenskaper
                                    "id": "chart1", 
                                },
                                {
                                    "uiType": "loremField",
                                    "id": "unknown1", //brukes som key til lagring i coreModel
                                },
                                {
                                    "uiType": "youtube",
                                    "url": "https://www.youtube.com/embed/DqOdbfER_DY", //ingen verdi å lagre, trenger ingen id
                                },
                                {
                                    "uiType": "buggyField",
                                },
                                {
                                    "uiType": "myText", 
                                    "myCaption": "My own textfield",
                                    "id": "myText1", 
                                },                                
                            ]
                            }
                        ]
                        },
                    extend: {
                        myText: {
                            render: function(field, context) {
                                var modelKey = context.getFieldId();
                                return `${field.myCaption}: <input type='text' value='${context.getValue()}' oninput='viewer.setFieldValue("${modelKey}", this.value)'></input>`;
                            },
                        },
                        map:  {
                            render: function(field, context) {
                                return `<div data-map='map'></div>`;
                            },
                            updateDom: function(field, context) {
                                var mapDiv = context.getElement("div[data-map]")[0];
                                var mymap = L.map(mapDiv).setView([field.longtitude, field.latitude], 13);

                                //TODO: tileLayer
                            },
                            summary: function(field, model, containerId) {
                                //TODO: hvordan feltet skal se ut på kontrollsiden
                            }
                        },
                        chart: {
                            render: function(field, model, containerId) {
                                return `<div>This is the CHART with id = '${field.id}' and customChartProperty1 = '${field.customChartProperty1}' property </div>`;
                            }
                        },
                        youtube: {
                            render: function(field) {
                                //can return HTML
                                return `<iframe width="560" height="315" src="${field.url}" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"></iframe>`;
                            }
                        },
                        buggyField: {
                            render: function(field) {
                                throw "error thrown by extension-field";
                            }
                        }                        
                    },
                    // formId: function() {
                    //     return viewer.util.getQuery("formId");
                    // },
                    // refId: function() {
                    //     return viewer.util.getQuery("refId");
                    // },
                    onStarting: function() {
                        console.log("viewer.onStarting()")
                    },
                    onStarted: function({template, model, customer}) {
                        console.log("viewer.onStarted()");
                    },
                    onSaving: function(proceed) {
                        proceed();
                    },
                    onSaved: function(saveInfo) {
                        proceed();
                    },
                    onAborting: function(proceed) {
                        proceed(); //be om bekreftelse før proceed() blir kalt. 
                    },
                    onAborted: function() {
                        window.location = "index.html";
                    },
                    onSubmitted: function(receipt) {
                        window.location = "submitReceipt.html?refId=" + receipt.refId;
                    },
                    onAuthenticationRequired: function(info) {
                        viewer.logIn({securityLevel: info.requiredSecurityLevel});
                        //om ønskelig, kan URL for autentisering hentes via viewer.getLogInUrl({securityLevel: info.requiredSecurityLevel}).
                    },
                }).catch((error) => {
                    alert(error);
                }).finally(() => {
                    setLoaderVisibility(false);
                });
        });
    </script>

    <div id="viewer"></div>

    <div id="loader" class="loader"></div>

    <script src="http://localhost/face/prod/k247.min.js?ver=1.0.0.0"></script>
    <script src="script.js"></script>
</body>
</html>